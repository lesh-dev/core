#!/bin/bash -e

# VPS Backuper
# ------------
# Please DO NOT EDIT THIS FILE directly, these changes will be LOST
# when updating script from git repo.
# Instead, edit <git-repo-root>/tools/backuper/backup.sh and then deploy it
# to /srv/tools/backup.sh

backup_folder=/backup

rm -rf $backup_folder
mkdir -p $backup_folder

#tar cvzf $backup_folder/test.tgz /srv/test
tar cvzf $backup_folder/git.tgz  /srv/git
tar cvzf $backup_folder/trac.tgz /srv/trac
tar cvzf $backup_folder/etc.tgz  /etc

back_date="`date +%Y-%m-%d`"
#rsync -avz /root/backup doctor@doctor.dtdns.net:/data/backup/lesh/$back_date/
chown -R mvel:mvel $backup_folder
# reverse scp-ying works!
dest_host=mvel@mvel.dtdns.net
dest_folder=backup/lesh/$back_date/
ssh $dest_host mkdir -p $dest_folder
ssh $dest_host scp fizlesh.ru:$backup_folder/* $dest_folder
echo "OK" > /tmp/backup-status
