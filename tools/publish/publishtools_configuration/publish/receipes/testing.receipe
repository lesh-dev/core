#!/usr/bin/env bash
# Generated from template on Tue Oct  9 22:33:23 MSK 2012
# Please don't forget to commit all changes to repo

components=" preprod_copy"
branch=master
target=/srv/www/clones/testing
sympolicy=none

# This will be executed while publishing component begin
function hook_begin
{
    rm -rf $target
    echo -en  # Add something useful if you want
}

# This will be executed while publishing component preprod_copy
function hook_preprod_copy
{
    echo -en  # Add something useful if you want
}

# This will be executed while publishing component end
function hook_commit
{
    cd $target
    if [ $(pwd) != $target ]; then
        echo " *** ERROR *** Can't create save state"
    else
        git add -A
        git commit -am "save state"
    fi
}

function hook_reset
{
    cd $target
    if [ $(pwd) != $target ]; then
        echo " *** ERROR *** Can't create save state"
    else
        git reset --hard
        git clean -f
        chown -R www-data:www-data .
    fi
}

# Some fizlesh.ru spikes
# TODO: unhardcode fizlesh.sqlite name
function xsm_clear_notifications
{
    db="content/ank/fizlesh.sqlite3"
    if [ -w "$db" ] ; then
        echo 'DELETE FROM notification;' | sqlite3 "$db"
        echo "Notifications table cleared successfully"
    fi

    mc="content/cms/mailer.conf"
    if [ -w "$mc" ] ; then
        mail_test="vdm-photo@ya.ru"
        cat > "$mc" <<EOF
user-change:$mail_test
content-change:$mail_test
reg:$mail_test
reg-managers:$mail_test
reg-test:$mail_test
reg-managers-test:$mail_test
EOF
        echo "Mailer config was reset to '$mail_test' address for each notification handler"
    fi

}

function hook_end
{
    cd $target
    if [ $(pwd) != $target ]; then
        echo " *** ERROR *** Can't create save state"
    else
        xsm_clear_notifications
        git init
        hook_commit
    fi
    # create robots.txt to prevent indexing (#426)
    cat > robots.txt <<EOF
User-Agent: *
Disallow: /
EOF
    apachectl -k graceful
}
