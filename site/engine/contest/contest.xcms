<!DOCTYPE html>
<html><head>
    <title>Contest</title>
    <# js/bootstrap #>
    <# js/jquery #>
    <# css/public contest.css #>
</head>
<body>
<# url #>
<# auth/ #ank #admin #editor #>
<?php

require_once("${engine_dir}sys/db.php");
require_once("${engine_dir}contest/scheme.php");
require_once("${engine_dir}contest/forms.php");
require_once("${engine_dir}contest/action.php");

function ctx_custom_form($table_name, $pk, $item_template)
{
    global $CTX_META, $content_dir, $CONTEST_CURRENT_YEAR;
    $ans = "";
    if (@$_POST["ctx_custom_$table_name"])
    {
        $values = array();
        ctx_update_object($table_name, $values);
        $ans .= "Запись добавлена. ";
        if ($return)
            $ans .= "<a href='$return'>Вернуться.</a>";
    }
    else
    {
        $ans .= "<form enctype='multipart/form-data'
            method=\"POST\"><input type='hidden' name='MAX_FILE_SIZE' value='15000000' />";

        $values = xdb_get_entity_by_id($table_name, $pk);
        foreach($values as $k=>$v)
            $item_template = str_replace("{".$k."}", $v, $item_template);
        $item_template = str_replace(
            "{#submit}",
            "<input class='btn btn-primary' type='submit'
                name='ctx_add_or_edit_form_$table_name' value='Добавить / Изменить' />",
            $item_template);
        $ans .= "</form>";
    }
}

function ctx_add_or_edit_form($table_name, $pk, $operation, $return, $fid="x", $defvalues=array())
{
    global $CTX_META, $content_dir, $CONTEST_CURRENT_YEAR;
    $show_form = true;
    if (@$_POST["ctx_add_or_edit_form_${table_name}_$fid"])
    {
        $show_form = false;
        $values = array();
        if (strlen($pk) && $pk != XDB_NEW)
            $values = xdb_get_entity_by_id($table_name, $pk);

        ctx_update_object($table_name, $values);
        if ($return == "stay")
            $show_form = true;
        else
        {
            echo "Запись добавлена. ";
            if ($return)
                echo "<a href=\"$return\">Вернуться</a>\n";
            else "<meta http-equiv=\"refresh\" content=\"0\"></meta>";
        }
    }

    if ($show_form)
    {
        echo "<form enctype='multipart/form-data' method=\"POST\">
            <input type='hidden' name='MAX_FILE_SIZE' value='15000000' />";
        $cls = "table-condensed";
        if ($operation == "view")
            $cls .= " table table-bordered table-hover";
        echo "<table class='$cls'>\n";
        $values = array();
        if ($pk)
            $values = xdb_get_entity_by_id($table_name, $pk);

        foreach($CTX_META[$table_name] as $id=>$arr)
        {
            $name = $arr["name"];
            $type = $arr["type"];
            $value = @$values[$id];
            if (!strlen($value))
                $value = @$defvalues[$id];
            if ($operation == "edit")
                xcmst_draw_contest_form_field($type, $name, $value, $id);
            elseif ($operation == "view")
                xcmst_draw_contest_form_view($type, $name, $value);
        }
        echo "</table>\n";
        if ($operation == "edit")
            echo "<input type='submit' class='btn btn-primary' name='ctx_add_or_edit_form_${table_name}_$fid' value='Добавить / изменить' />";
        echo "</form>";
    }
}

function ctx_show_tasty_list($table_name, $order, $filter, $row_template)
{
    global $CTX_META, $ref;
    $ans = "";
    $rows = xdb_get_table($table_name, $order, $filter);
    foreach ($rows as $line)
    {
        $template = $row_template;
        foreach($line as $field=>$value)
        {
            $template = str_replace("{".$field."}", $value, $template);
        }
        $pk = $line["${table_name}_id"];
        $template = str_replace("{#edit}", "href='?ref=$ref&amp;mode=edit&amp;table=$table_name&amp;id=$pk'", $template);
        $template = str_replace("{#view}", "?ref=$ref&amp;mode=view&amp;table=$table_name&amp;id=$pk", $template);
        $ans .= $template;
    }
    return $ans;
}

function ctx_show_submitted()
{
    global $content_dir;

    $items = glob("${content_dir}contest/[0-9]*", GLOB_ONLYDIR); ?>
    <table class="table table-striped table-bordered table-condensed table-hover">
    <thead><tr>
        <th>Дата</th>
        <th>EMail</th>
        <th>Файл</th>
    </tr></thead><tbody><?php
    foreach ($items as $item)
    {
        $timestamp = (int)(preg_replace('#.*/#', '', $item));
        $date_time = xcms_datetime($timestamp);
        $list = xcms_get_list("$item/config.ini");
        ?>
        <tr>
            <td><?php echo $date_time; ?></td>
            <td><?php echo $list['mail']; ?></td>
            <td><a href="<?php echo "$item/".$list["attachment"]; ?>"><?php echo $list["attachment"]; ?></a></td>
        </tr>
        <?php
    }
    ?>
    </tbody></table><?php
}

?>
<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <a class="brand" href="?ref=contest">Проверка олимпиады &mdash; <?php echo $CONTEST_CURRENT_YEAR; ?></a>
        <ul class="nav">
            <li><a href="?ref=contest&amp;mode=problems" >Задачи</a></li>
            <li><a href="?ref=contest&amp;mode=submitted" >Присланное</a></li>
            <li><a href="?ref=contest&amp;mode=works" >Работы</a></li>
            <li><a href="?ref=contest&amp;mode=edit&amp;table=contestants" >Добавить работу</a></li>
        </ul>
    </div>
</div>

<div class="site-body">

<div id="container">
<?php
    $FILTER = "( contest_year = \"$CONTEST_CURRENT_YEAR\" )";
    $mode = @$_GET["mode"];
    if ($mode == "problems")
    {
        echo ctx_show_tasty_list("problems", NULL, $FILTER,
            "<b>Задача <a href='{#view}'>{problem_name}</a></b>, проверяют: {people}<br />");
        echo "<a href='?ref=$ref&amp;mode=edit&amp;table=problems'>Добавить еще одну задачу</a><br/>";
    }

    if ($mode == "submitted")
        ctx_show_submitted();

    if ($mode == "works")
    {
        $probs = xdb_get_table("problems", NULL, $FILTER);
        $works = ctx_get_works();

        $results = ctx_calculate_results($works, $probs);

        $undone = $results['undone'];
        $done = $results['done'];
        $done_sum = $results['done_sum'];

        // header
        ?>
        <h3>Непроверенные</h3>
        <table class="table table-striped table-bordered table-condensed table-hover">
        <thead><tr>
            <th>Ученик</th>
            <th>Класс</th>
            <th>Работа</th>
        <?php
        foreach ($probs as $value)
            echo "<th>".xu_substr($value["problem_name"], 0, 2); ?>
            <th colspan="2">Баллы</th>
        </tr></thead><?php

        foreach ($undone as $work)
            echo "<tr>".ctx_print_result_row($work, $probs)."</tr>\n";
        ?>
        </table>

        <h3>Проверенные</h3>
        <table class='table table-striped table-bordered table-condensed table-hover'>
        <thead><tr>
            <th>№</th>
            <th>Ученик</th>
            <th>Класс</th>
            <th>Работа</th>
        <?php
        // header
        foreach ($probs as $value)
            echo "<th>".xu_substr($value["problem_name"], 0, 2)."</th>";?>
            <th colspan="2">Баллы</th>
        </tr></thead><?php

        $i = 1;
        foreach ($done_sum as $sum)
            foreach ($done[$sum] as $work)
            {
                echo "<tr><td>$i</td>".ctx_print_result_row($work, $probs)."</tr>\n";
                $i++;
            }
        ?></table><?php
    }

    if ($mode == "edit")
    {
        if ($_GET["table"] == "contestants" && @$_GET["id"] != "")
            unset($CTX_META["contestants"]["work"]);

        ctx_add_or_edit_form(@$_GET["table"], @$_GET["id"], "edit", @$_SERVER["HTTP_REFERER"]);
    }

    if ($mode == "structure")
    {
        if (@$_POST)
        {
            ctx_create_structure();
        }
        echo "<h3>Запрос на удаление</h3>";
        echo "<h1>СТОЙ!!! ПОДУМАЙ, ЧТО ТЫ ДЕЛАЕШЬ!!!!</h1>";
        echo "<form method='post'><input name='delete'
            value='ОЧИСТИТЬ ВООБЩЕ ВСЮ БАЗУ' class='btn btn-danger' type=\"submit\"></form>";
    }

    if ($mode == "delete")
        xcmst_contest_delete_entity();

    if ($mode == "view")
    {
        $table = $_GET["table"];

        if ($table == "contestants")
        {
            echo '<ul class="nav nav-pills">';
            $problems_table = xdb_get_table("problems", NULL, $FILTER);
            $solutions_table = xdb_get_table("solutions", NULL, $FILTER);
            if (!@$_GET["pid"]) $activeness = "class='active'";
            else $activeness = "";
            echo "<li $activeness ><a
                href='?ref=$ref&mode=view&table=contestants&id={$_GET['id']}' >Информация</a></li>";

            foreach($problems_table as $problem)
            {
                if (@$_GET["pid"] == $problem["problems_id"]) $activeness = "class='active'";
                else $activeness = "";;
                echo "<li $activeness><a
                    href='?ref=$ref&mode=view&table=contestants&id={$_GET['id']}&pid={$problem["problems_id"]}' >".
                    $problem["problem_name"]."</a></li>";
            }
            echo "</ul>";

            if (!@$_GET["pid"])
            {
                echo '<div class="tab-pane active" id="def">';
                ctx_add_or_edit_form(@$_GET["table"], @$_GET["id"], "view", @$_SERVER["HTTP_REFERER"]);
                echo "<a class='btn btn-warning' href='?ref=$ref&mode=edit&id={$_GET['id']}&table=$table'>Правка</a>";
                echo '</div>';
            }

            foreach ($problems_table as $problem)
            {
                $c_id = $_GET["id"];
                $p_id = $problem["problems_id"];
                $sid = XDB_NEW;
                if ($p_id != @$_GET["pid"]) continue;
                echo '<div class="tab-pane" id="pr_'.$problem["problems_id"].'">';
                foreach($solutions_table as $line)
                {
                    if ($line["problem_id"] != $p_id) continue;
                    if ($line["contestant_id"] != $c_id) continue;
                    $sid = $line["solutions_id"];

                }
                echo "<h3>".$problem["problem_name"]."</h3>";
                $retur = ($sid == XDB_NEW) ? false : 'stay';
                ctx_add_or_edit_form("solutions", $sid, "edit", $retur, $c_id.$p_id,
                    array("problem_id"=>$p_id, "contestant_id"=>$c_id));
                //ctx_add_or_edit_form("problems", $_GET["id"]);
                echo "</div>";
            }

        }
        else
        {
            ctx_add_or_edit_form(@$_GET["table"], @$_GET["id"], "view", @$_SERVER["HTTP_REFERER"]);
            echo "<a href='?ref=$ref&mode=edit&id={$_GET['id']}&table=$table'>Правка</a>";
        }

    }

?>
</div>
</div>
</body></html>