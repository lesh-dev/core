<? $extime = microtime();?>
<# if //@$_GET['act']=='logout'//auth/logout//#>
<? if(!@$_GET["page"])$_GET["page"]="index";?>
<# cms/linit #>
<# locale #>
<?
                $INFO = @getList("{$SETTINGS["datadir"]}cms/pages/$pageid/info");
 		include(translate("<! auth/ #cmseditor #admin root {$INFO["edit"]} !>"));
?> 
<# cms/.lightcreatepage-before #>
<?

                if(@$_POST["delete-section"])
                {
                  $dir = "{$SETTINGS["datadir"]}cms/pages/$pageid";
                  $list = glob("$dir/*",GLOB_ONLYDIR);
                  if($list) 
                  {
                    echo '<script>alert("Не могу удалить! Сначала удалите все подразделы!");</script>';
                  }     
                  else 
                  {
                    $list = glob("$dir/*");
                    if($list) foreach ($list as $key=>$value) 
                    {
                      unlink($value);
                    }
                    rmdir($dir); 
                    echo '<script>alert("Удалено");</script>';
                    translate("<! redir ladmin 0!>");
                    //die();
                    $pageid="index";
                    for($i=strlen($pageid)-1;$i>=0; $i--)
                    {
                      if($pageid[i]=='/'){$pageid[i]=substr($pageid,0,$i-1); break;}
                    }
                    
                    $INFO = @getList("{$SETTINGS["datadir"]}cms/pages/$pageid/info");
                    @$_GET["act"]="";
                  }             
                }

?>

<html>
  <head>
  </head>
  
  <body>
    <b>xcms admin: </b> <? echo $pageid; ?> 
    <hr>
  </body>
</html>


<html>
  <# cms/head #>
  <# cms/.light_mce #>
  <body BGColor="A1C2D4">

            <table height="100%"  width = "100%" border = "0" cellpadding = "0" cellspacing = "0">
                      <tr>
                            <td width="160" valign="top">
                            <table height="100%"  width = "100%" border = "0" cellpadding = "0" cellspacing = "0">
                            
                            
                            
                            
                                  <tr height="150">
                                  <td><# help/display #><img border="0" SRC="pic/emblem-mid-i.gif" width="150"></a></td>
                                  
                                  
                                  </tr>
                            
                            
                            
                                  <tr height="5"><td align="center">
                                    <a class="menulink"><? echo '{'.@file_get_contents("data/cms/pages/$pageid/applymenu")."}"; ?></a>
                                    <br>
                                    <a class="menulink"><font style="font-size:5pt;"><? echo '{'.$pageid."}"; ?></font></a>
                                    </td></tr>
                            
                            
                            
                            
                                  <tr height="100%">
                                  
                                  
                                  <td valign="top">
                                  
                                  
                                  
                                                        
      <?php

        include(
          translate(
            //'<h2><! cms/SectionName !></h2>'.
            '<p><p><table cellspacing=0 cellpadding=0 width="100%"><! var forceSn 1 !><! cms/menu/display displayall start=1 end=5 !>
            </table>
            
            '
            )
          );
      include(translate('            <hr>
            <font class="menuLinkA"><a href="?act=myprofile&page='."$pageid&ref=ladmin".'" class="menulink">Мой профиль</a></font>
            <br /><font class="menuLinkA"><a href="?act=cpasswd&page='."$pageid&ref=ladmin".'" class="menulink">Сменить пароль</a></font>
            <br /><font class="menuLinkA"><a href="?page='."$pageid&ref=index".'" class="menulink">Просмотр сайта</a></font>
            <br /><font class="menuLinkA"><a href="?act=logout&page='."$pageid&ref=$ref".'" class="menulink">Выход из системы</a></font>

            <br /><hr><font class="menuLinkA"><a href="?act=cChapter&page='."$pageid&ref=ladmin".'" class="menulink">Создать подраздел</a></font>
            <br /><font class="menuLink3"><a href="?act=rename_section&page='."$pageid&ref=ladmin".'" class="menulink">Переименовать раздел</a></font>
            <br /><font class="menuLinkA"><a href="?act=delete&page='."$pageid&ref=ladmin".'" class="menulink">Удалить раздел</a></font>
            
            <br /><hr><font class="menuLinkA"><a href="?act=cleanprec&page='."$pageid&ref=ladmin".'" class="menulink">Очистить кэш</a></font>
            <br /><font class="menuLinkA"><a href="?act=userlist&page='."$pageid&ref=ladmin".'" class="menulink">Пользователи</a></font>
            <br /><font class="menuLinkA"><a href="?act=css&page='."$pageid&ref=ladmin".'" class="menulink">CSS . . .</a></font>
            <br /><font class="menuLinkA"><a href="?act=taglist&page='."$pageid&ref=ladmin".'" class="menulink">Автодополнение</a></font>
            
            <br /><font class="menuLink3"><a href="?act=logout&page='."$pageid&ref=admin".'" class="menulink">Старая админка</a></font>
<hr>
'));      
    if($type!="album")include(translate("<! cms/.lightimageeditor !>"));
      ?>
</td></tr>
</table>
</td>
                            <td width="5">&nbsp;</td>
                       
                            
                            
                            
                            
                            <td>
                            
                                         <table height="100%"  width="100%" border = "0" cellpadding = "0" cellspacing = "0">
                            
                                                <tr height="30">
                                                <td> <p align="center"><# cms/header #></p> </td>
                                                </tr>
                                    
                                    
                                    
                                    <tr height="1">
                                    <? if(!@$_GET["act"])echo
                                    '<td bgcolor="#FFFFFF" > 
                                    <a class="menulinkA" href="?ref=ladmin&page='.$pageid.'">[Редактирование]</a>
                                    <a class="menulinkA" href="?mode=meta&ref=ladmin&page='.$pageid.'">[Описание]</a>
                                    <a class="menulinkA" href="?mode=acsess&ref=ladmin&page='.$pageid.'">[Доступ]</a>
                                    <a class="menulinkA" href="?mode=configuration&ref=ladmin&page='.$pageid.'">[Конфигурация]</a>
                                    <a class="menulinkA" href="?mode=documentation&ref=ladmin&page='.$pageid.'">[Документация]</a>
                                    </td> '; ?>
                                    
                                    <tr>
                                    
                                    
                                    <tr>
                                        <td valign="top"  height="100%">
						 <table width="">
<?
  if(@$_GET["mode"] == "")
    @$_GET["mode"] = @$_GET["act"];
  if(@$_GET["act"] == "")
    @$_GET["act"] = @$_GET["mode"];
  if(@$_GET["act"]=="cpasswd")
  {
    include(translate('<! auth/chpassw !>'));
  }
  else if(@$_GET["act"]=="cleanprec") include(translate("<! cleanprec !>"));
  else if(@$_GET["act"]=="delete")
  {
    echo '
      <h3><font color="red">Предупреждение.</font></h3>
      Вы хотите удалить текущий раздел <b>'.@file_get_contents("data/cms/pages/$pageid/applymenu").'</b>.
      <br>Вы <b>точно</b> уверены, что хотите это сделать?
      
      <form method="post"><input type="hidden" name="delete-section" value="true">
      <input type="submit" value="Да, я точно уверен, что следует удалить раздел '.@file_get_contents("data/cms/pages/$pageid/applymenu").'">
      </form>
    ';
    
  }
  else if(@$_GET["mode"]=="meta" || @$_GET["act"]=="meta")
  {
    include(translate("<! cms/.lighteditmenu !>"));
    include(translate("<! cms/.lighteditrename !>"));
    include(translate("<! cms/editmetatags !>"));
    include(translate("<! cms/.lighticoneditor !>"));
  }
  else if(@$_GET["mode"]=="configuration" || @$_GET["act"]=="configuration")
  {
    $editfile = "{$SETTINGS["datadir"]}cms/pages/$pageid/info";    
    include(translate('<! edit/tag `edit`,`view`,`installed` !>'));  
  }
  else if(@$_GET["mode"]=="documentation")
  {
    $editfile = "help/pagetype_$type.html";
    $text = "Справки нет. Напишите что-нибудь...";
    if(
    	(@$_POST['change-help'] || !file_exists($editfile) || @$_POST["edit-submit"])
    	&& ($login == "root") )
    {
    	include(translate('<! edit/file !>'));
	echo '<form method="POST"><input type="submit" value="Закончить." name="change-help-end"></form>';
    }
    else 
    {
    	$source = $editfile;
    	include(translate("<! cms/readfile source !>"));
	if($login == "root") 
		echo '<p><form method="POST"><input type="submit" value="Изменить!" name="change-help"></form>';    
    }
    
  }
  else if(@$_GET["act"]=="css")
  {
    include(translate('<! cms/.lightcsseditor !>'));  
  }
  else if(@$_GET["act"]=="taglist")
  {
    include(translate('<! edit/taglistadmin !>'));  
  }
  else if(@$_GET["mode"]=="acsess")
  {
    include(translate("<! cms/.lightacsesseditor !>"));
  }
  else if(@$_GET["act"]=="rename_section")
  {
    include(translate("<! cms/.lightrenamesection !>"));
  }
  else if(@$_GET["act"]=="userlist")
  {
    $preface = "ref=ladmin&act=userlist&page=$pageid";
    include(translate("<! auth/admin !>"));
  }
  else if(@$_GET["act"]=="myprofile")
  {
    $preface = "ref=ladmin&act=userlist&page=$pageid";
    include(translate("<! auth/myprofile !>"));
  }
  else if(@$_GET["act"]=="cChapter")
  {
/*    echo '
      <h3>Создание подраздела в разделе '.$pageid.'</h3>
      <form>
        <table>
          <tr>
            <td>Служебное имя <br> <font size="-1">Если Вы не знаете, что это такое - оставьте без изменений.</font>
            <td><input name="chapname">
        </table>
      </form>
    ';
  */
    include(translate("<! cms/.lightcreatepage-after !>"));
  }
  else include(translate('<! cms/.lightedittable !>'));
?>
<? $extime = microtime()-$extime;?>
<CENTER><font size="-2">Script execution time: <? echo ((int)($extime*10000))/10; ?> msec</font></CENTER>
                                                      </div></td>
                                        
                                        
                                        
                                        
                                        
                                        </td>
                                    </tr>
                            
                            
                            </table>
                            
                            </td> 
                      
                      </tr>
                      
                     
            
            
            </table>
            
            
            
  </body>
</html>
